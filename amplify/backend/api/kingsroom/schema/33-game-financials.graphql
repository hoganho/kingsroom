# 33-game-financials.graphql
# ===================================================================
# GAME FINANCIALS PROCESSOR
# Schema for calculating and persisting game financial data
# 
# VERSION 2.0.0 - totalGuaranteeOverlayCost now included in totalCost
# 
# CHANGELOG:
# - v2.0.0: totalGuaranteeOverlayCost tracking
#           - totalGuaranteeOverlayCost now distinct from prizepoolAddedValue
#           - totalGuaranteeOverlayCost included in totalCost calculation
#           - costPerPlayer reflects total cost including overlay
#           - Added guaranteeOverlayPerPlayer metric
# ===================================================================

# ===================================================================
# INPUT TYPES
# ===================================================================

input CalculateGameFinancialsInput {
  # Option 1: Provide full game data (for preview before save)
  game: GameFinancialsGameInput
  
  # Option 2: Provide gameId (fetch from DB and calculate)
  gameId: ID
  
  # Control options
  options: GameFinancialsOptionsInput
}

# Game data input for financial calculation
# Subset of Game fields needed for financials
input GameFinancialsGameInput {
  id: ID!
  entityId: ID!
  venueId: ID
  
  # Entry data
  totalEntries: Int
  totalUniquePlayers: Int
  totalInitialEntries: Int
  totalRebuys: Int
  totalAddons: Int
  
  # Financial inputs
  buyIn: Float
  rake: Float
  venueFee: Float
  guaranteeAmount: Float
  hasGuarantee: Boolean
  
  # Pre-calculated financials (from enricher)
  rakeRevenue: Float
  totalBuyInsCollected: Float
  prizepoolPlayerContributions: Float
  
  # v2.0.0: Separated overlay cost from promotional added value
  prizepoolAddedValue: Float         # Promotional added value (e.g., "+$5k added prizepool")
  guaranteeOverlayCost: Float        # Unplanned cost from not meeting guarantee
  
  prizepoolSurplus: Float
  gameProfit: Float
  
  # Results
  prizepoolPaid: Float
  prizepoolCalculated: Float
  
  # Timing
  gameStartDateTime: AWSDateTime
  gameEndDateTime: AWSDateTime
  
  # Classification
  gameType: GameType
  tournamentType: TournamentType
  gameStatus: GameStatus
}

input GameFinancialsOptionsInput {
  # If true, save to GameCost and GameFinancialSnapshot tables
  # If false (default), just return calculated values for preview
  saveToDatabase: Boolean
}

# ===================================================================
# OUTPUT TYPES
# ===================================================================

type CalculateGameFinancialsOutput {
  success: Boolean!
  gameId: ID
  mode: String!                              # "PREVIEW" or "SAVE"
  
  # Calculated cost data
  calculatedCost: GameCostCalculation
  
  # Calculated snapshot data
  calculatedSnapshot: GameFinancialSnapshotCalculation
  
  # Summary for quick FE display
  summary: FinancialsSummary
  
  # Save results (only populated when saveToDatabase is true)
  costSaveResult: FinancialsSaveResult
  snapshotSaveResult: FinancialsSaveResult
  
  # Metadata
  processingTimeMs: Int
  error: String
}

# Calculated GameCost data
type GameCostCalculation {
  gameId: ID
  entityId: ID
  venueId: ID
  gameDate: AWSDateTime
  
  # Staff costs
  totalDealerCost: Float
  totalTournamentDirectorCost: Float
  totalFloorStaffCost: Float
  totalSecurityCost: Float
  totalStaffCost: Float
  
  # Direct game costs
  totalPrizeContribution: Float              # Promotional added value (NOT overlay)
  totalJackpotContribution: Float
  totalBountyCost: Float
  totalDirectGameCost: Float
  
  # v2.0.0: Overlay and added value costs (SEPARATED)
  totalGuaranteeOverlayCost: Float           # Unplanned cost from not meeting guarantee
  totalAddedValueCost: Float                 # Planned promotional expense
  
  # Operations costs
  totalVenueRentalCost: Float
  totalEquipmentRentalCost: Float
  totalFoodBeverageCost: Float
  totalOperationsCost: Float
  
  # Marketing costs
  totalMarketingCost: Float
  totalStreamingCost: Float
  
  # Compliance costs
  totalInsuranceCost: Float
  totalLicensingCost: Float
  totalComplianceCost: Float
  
  # Other costs
  totalStaffTravelCost: Float
  totalPlayerAccommodationCost: Float
  totalPromotionCost: Float
  totalOtherCost: Float
  
  # Total (NOW INCLUDES OVERLAY)
  totalCost: Float
  
  # Calculation metadata
  dealerRatePerEntry: Float
  entriesUsedForCalculation: Int
}

# Calculated GameFinancialSnapshot data
type GameFinancialSnapshotCalculation {
  gameId: ID
  entityId: ID
  venueId: ID
  gameStartDateTime: AWSDateTime
  
  # Denormalized game data
  totalUniquePlayers: Int
  totalEntries: Int
  guaranteeAmount: Float
  gameDurationMinutes: Int
  gameType: GameType
  tournamentType: TournamentType
  
  # Revenue
  totalBuyInsCollected: Float
  rakeRevenue: Float
  venueFee: Float
  totalRevenue: Float
  
  # Prizepool
  prizepoolPlayerContributions: Float
  prizepoolAddedValue: Float                 # Promotional added value only
  prizepoolTotal: Float
  prizepoolSurplus: Float
  
  # Prizepool Adjustments
  prizepoolPaidDelta: Float
  prizepoolJackpotContributions: Float
  prizepoolAccumulatorTicketPayoutEstimate: Float
  prizepoolAccumulatorTicketPayoutActual: Float
  
  # Guarantee
  guaranteeOverlayCost: Float
  guaranteeCoverageRate: Float
  guaranteeMet: Boolean
  
  # v2.0.0: Overlay and added value costs (SEPARATED)
  totalGuaranteeOverlayCost: Float           # Unplanned cost from not meeting guarantee
  totalAddedValueCost: Float                 # Planned promotional expense
  totalPrizeContribution: Float              # = totalAddedValueCost (NOT overlay)
  
  # Staff costs
  totalDealerCost: Float
  totalStaffCost: Float
  totalTournamentDirectorCost: Float
  totalFloorStaffCost: Float
  totalSecurityCost: Float
  
  # Other cost breakdowns
  totalJackpotContribution: Float
  totalBountyCost: Float
  totalDirectGameCost: Float
  totalVenueRentalCost: Float
  totalEquipmentRentalCost: Float
  totalFoodBeverageCost: Float
  totalOperationsCost: Float
  totalMarketingCost: Float
  totalStreamingCost: Float
  totalInsuranceCost: Float
  totalLicensingCost: Float
  totalComplianceCost: Float
  totalStaffTravelCost: Float
  totalPlayerAccommodationCost: Float
  totalPromotionCost: Float
  totalOtherCost: Float
  
  # Total cost (NOW INCLUDES OVERLAY)
  totalCost: Float
  
  # Profit
  gameProfit: Float
  netProfit: Float
  profitMargin: Float
  
  # Per-player metrics (v2.0.0: costPerPlayer now includes overlay)
  revenuePerPlayer: Float
  costPerPlayer: Float                       # Now includes overlay cost
  profitPerPlayer: Float
  rakePerEntry: Float
  staffCostPerPlayer: Float
  dealerCostPerHour: Float
  guaranteeOverlayPerPlayer: Float           # NEW: Overlay cost per player
}

# Summary for quick FE display
type FinancialsSummary {
  # Revenue
  totalRevenue: Float
  rakeRevenue: Float
  totalBuyInsCollected: Float
  
  # Costs (v2.0.0: Now includes overlay breakdown)
  totalCost: Float                           # Includes overlay
  totalDealerCost: Float
  totalGuaranteeOverlayCost: Float           # Unplanned overlay cost
  totalAddedValueCost: Float                 # Promotional added value
  totalPrizeContribution: Float              # = totalAddedValueCost
  
  # Prizepool
  prizepoolTotal: Float
  prizepoolPlayerContributions: Float
  prizepoolAddedValue: Float                 # Promotional only
  
  # Guarantee
  guaranteeMet: Boolean
  guaranteeOverlayCost: Float
  guaranteeCoverageRate: Float
  
  # Profit
  gameProfit: Float
  netProfit: Float
  profitMargin: Float
  
  # Per-player (v2.0.0: costPerPlayer includes overlay)
  revenuePerPlayer: Float
  costPerPlayer: Float                       # Includes overlay
  profitPerPlayer: Float
  rakePerEntry: Float
  guaranteeOverlayPerPlayer: Float           # NEW
  
  # Series/Recurring metadata
  isSeries: Boolean
  isSeriesParent: Boolean
  tournamentSeriesId: ID
  seriesName: String
  recurringGameId: ID
}

# Save operation result
type FinancialsSaveResult {
  action: String                             # "CREATED", "UPDATED", "ERROR"
  costId: ID
  snapshotId: ID
  error: String
}

# ===================================================================
# MUTATIONS
# ===================================================================

extend type Mutation {
  # Calculate game financials (with optional save)
  # - saveToDatabase: false → returns calculated data for preview
  # - saveToDatabase: true → saves to GameCost + GameFinancialSnapshot
  calculateGameFinancials(input: CalculateGameFinancialsInput!): CalculateGameFinancialsOutput!
    @function(name: "gameFinancialsProcessor-${env}")
}

# ===================================================================
# QUERIES (for re-fetching saved data)
# ===================================================================

extend type Query {
  # Preview financials without saving (alias for mutation with saveToDatabase: false)
  previewGameFinancials(input: CalculateGameFinancialsInput!): CalculateGameFinancialsOutput!
    @function(name: "gameFinancialsProcessor-${env}")
}