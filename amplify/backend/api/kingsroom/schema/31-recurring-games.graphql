# 31-recurring-games.graphql
# ===================================================================
# RECURRING GAMES
# VERSION 3.2.0 - Based on working schema + bulk processing operations
# ===================================================================

type RecurringGame
  @model(subscriptions: null)
  @auth(rules: [{ allow: private }]) {
  
  # === PRIMARY KEY ===
  id: ID!
  
  # === IDENTIFICATION ===
  name: String! 
    @index(name: "byRecurringGameName", sortKeyFields: ["venueId"])
  
  displayName: String
  description: String
  aliases: [String]
  
  # === RELATIONSHIPS ===
  entityId: ID!
    @index(name: "byEntityRecurringGame", sortKeyFields: ["venueId", "name"])
  entity: Entity @belongsTo(fields: ["entityId"])
  
  venueId: ID!
    @index(name: "byVenueRecurringGame", sortKeyFields: ["dayOfWeek", "name"])
  venue: Venue @belongsTo(fields: ["venueId"])
  
  # === SCHEDULE INFORMATION ===
  dayOfWeek: String 
    @index(name: "byDayOfWeekRecurring", sortKeyFields: ["venueId"])
  
  startTime: String 
  endTime: String 
  frequency: GameFrequency! @default(value: "WEEKLY")
  
  # === GAME CHARACTERISTICS ===
  gameType: GameType! @default(value: "TOURNAMENT")
  gameVariant: GameVariant!
  tournamentType: TournamentType
  sessionMode: String
  
  # Typical values
  typicalBuyIn: Float
  typicalRake: Float
  typicalStartingStack: Int
  typicalGuarantee: Float
  typicalDuration: Int
  
  # === JACKPOT CONTRIBUTION CONFIG ===
  hasJackpotContributions: Boolean @default(value: "false")
  jackpotContributionAmount: Float @default(value: "2")
  
  # === ACCUMULATOR TICKET CONFIG ===
  hasAccumulatorTickets: Boolean @default(value: "false")
  accumulatorTicketValue: Float @default(value: "100")
  
  # === STATUS & TRACKING ===
  isActive: Boolean! @default(value: "true")
  isPaused: Boolean @default(value: "false") 
  pausedReason: String 
  
  lastGameDate: AWSDateTime 
  nextScheduledDate: AWSDateTime 
  expectedInstanceCount: Int 
  
  # === CATEGORIZATION ===
  isSignature: Boolean @default(value: "false") 
  isBeginnerFriendly: Boolean @default(value: "false")
  isBounty: Boolean @default(value: "false")
  tags: [String] 
  
  # === MARKETING ===
  marketingDescription: String 
  imageUrl: AWSURL 
  socialMediaHashtags: [String]
  
  # === CONFIDENCE ===
  autoDetectionConfidence: Float 
  wasManuallyCreated: Boolean @default(value: "false")
  requiresReview: Boolean @default(value: "false")
  reviewReason: String
  
  # === STATISTICS ===
  totalInstancesRun: Int @default(value: "0")
  totalInstancesCancelled: Int @default(value: "0")
  avgAttendance: Float
  lastMonthAttendance: Float
  lastConfirmedDate: String
  lastCancelledDate: String
  
  # === RELATIONSHIPS (hasMany) ===
  gameInstances: [Game] @hasMany(indexName: "byRecurringGame", fields: ["id"])
  instances: [RecurringGameInstance] @hasMany(indexName: "byRecurringGameInstance", fields: ["id"])
  metrics: [RecurringGameMetrics] @hasMany(indexName: "byRecurringGameMetrics", fields: ["id"])
  
  # === METADATA ===
  notes: String 
  adminNotes: String 
  
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
  createdBy: String
  lastEditedBy: String
  lastEditedAt: AWSDateTime
}

# ===================================================================
# RECURRING GAME INSTANCE ENUMS
# ===================================================================

enum RecurringGameInstanceStatus {
  CONFIRMED           # Matched to actual Game record
  CANCELLED           # Did not occur - explicitly cancelled
  SKIPPED             # Did not occur - venue closed/holiday
  REPLACED            # Different game ran in its slot
  UNKNOWN             # No data - needs investigation
  NO_SHOW             # Expected but never appeared
}

enum InstanceDeviationType {
  NONE                # No deviation from expected
  TIME_CHANGE         # Different start time
  BUYIN_CHANGE        # Different buy-in
  GUARANTEE_CHANGE    # Different guarantee
  FORMAT_CHANGE       # Different structure
  SPECIAL_EDITION     # Same game but special version
  MULTIPLE            # Multiple deviations
}

# ===================================================================
# RECURRING GAME INSTANCE MODEL
# Created lazily when games are matched or gaps detected
# ===================================================================

type RecurringGameInstance
  @model(subscriptions: null)
  @auth(rules: [{ allow: private }]) {
  
  # === PRIMARY KEY ===
  id: ID!
  
  # === RELATIONSHIPS ===
  recurringGameId: ID!
    @index(name: "byRecurringGameInstance", sortKeyFields: ["expectedDate"])
  recurringGame: RecurringGame @belongsTo(fields: ["recurringGameId"])
  
  # The actual game that ran (null if cancelled/skipped/unknown)
  gameId: ID
    @index(name: "byGameInstance")
  
  # === DATE INFO ===
  expectedDate: AWSDate!
    @index(name: "byExpectedDate", sortKeyFields: ["recurringGameId"])
  
  dayOfWeek: String!
  
  weekKey: String!
    @index(name: "byWeekKey", sortKeyFields: ["venueId"])
  
  # === DENORMALIZED FOR QUERIES ===
  venueId: ID!
    @index(name: "byVenueInstance", sortKeyFields: ["expectedDate"])
  
  entityId: ID!
    @index(name: "byEntityInstance", sortKeyFields: ["expectedDate"])
  
  recurringGameName: String
  
  # === STATUS ===
  status: RecurringGameInstanceStatus! @default(value: "CONFIRMED")
  
  # === DEVIATION TRACKING ===
  hasDeviation: Boolean @default(value: "false")
  deviationType: InstanceDeviationType
  deviationDetails: AWSJSON
  
  # === NOTES ===
  notes: String
  adminNotes: String
  cancellationReason: String
  
  # === REVIEW FLAGS ===
  needsReview: Boolean @default(value: "false")
  reviewReason: String
  
  # === TIMESTAMPS ===
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

# ===================================================================
# INPUT TYPES - BULK PROCESSING
# ===================================================================

input ProcessUnassignedGamesInput {
  venueId: ID
  entityId: ID
  dayOfWeek: String
  limit: Int
  autoCreate: Boolean
  requirePatternConfirmation: Boolean
  dryRun: Boolean
  batchSize: Int
  delayMs: Int
}

input ReprocessDeferredInput {
  venueId: ID
  entityId: ID
  dayOfWeek: String
  limit: Int
}

input UnassignedGamesStatsInput {
  venueId: ID
  entityId: ID
}

input PreviewPatternsInput {
  venueId: ID!
  minOccurrences: Int
}

# ===================================================================
# INPUT TYPES - ADMIN OPERATIONS
# ===================================================================

input AdminThresholdsInput {
  highConfidence: Int
  mediumConfidence: Int
  crossDaySuggestion: Int
  duplicateSimilarity: Float
}

input ReResolveInput {
  gameId: ID!
  thresholds: AdminThresholdsInput
  preview: Boolean
}

input ReResolveVenueInput {
  venueId: ID!
  thresholds: AdminThresholdsInput
  preview: Boolean
}

input MergeDuplicatesInput {
  canonicalId: ID!
  duplicateIds: [ID!]!
  preview: Boolean
}

input CleanupOrphansInput {
  venueId: ID!
  preview: Boolean
}

# ===================================================================
# RESULT TYPES - BULK PROCESSING
# ===================================================================

type ProcessedGameDetail @aws_iam @aws_cognito_user_pools {
  gameId: ID!
  gameName: String
  status: String!
  recurringGameId: ID
  recurringGameName: String
  confidence: Float
  wasCreated: Boolean
  error: String
  # For dry run preview - shows what template the game would be assigned to
  suggestedTemplateName: String
  clusterSize: Int
}

# Template that would be created during bulk processing (dry run preview)
type PotentialTemplate @aws_iam @aws_cognito_user_pools {
  suggestedName: String!
  dayOfWeek: String!
  gameType: String!
  sessionMode: String!
  variant: String
  gameCount: Int!
  avgBuyIn: Float
  buyInRange: String
  timeSlot: String
  confidence: String
  sampleGames: [PatternSampleGame!]
  status: String
}

type ProcessUnassignedGamesResult @aws_iam @aws_cognito_user_pools {
  success: Boolean!
  processed: Int!
  assigned: Int!
  created: Int!
  deferred: Int!
  noMatch: Int!
  errors: Int!
  dryRun: Boolean!
  message: String
  error: String
  details: [ProcessedGameDetail!]!
  # Potential templates that would be created (dry run only)
  potentialTemplates: [PotentialTemplate!]
}

type UnassignedGamesStats @aws_iam @aws_cognito_user_pools {
  # Venue-specific stats (for selected venue)
  total: Int!
  unprocessed: Int!
  candidateRecurring: Int!
  notRecurring: Int!
  assigned: Int!
  other: Int
  
  # Overall stats (all venues)
  overallTotal: Int!
  overallUnprocessed: Int!
  overallCandidateRecurring: Int!
  overallNotRecurring: Int!
  overallAssigned: Int!
  overallOther: Int
  
  # Breakdowns (AWSJSON - parsed on frontend)
  byVenue: AWSJSON
  byDay: AWSJSON
  byStatus: AWSJSON
}

type PatternSampleGame @aws_iam @aws_cognito_user_pools {
  id: ID!
  name: String
  date: String
}

type CandidatePattern @aws_iam @aws_cognito_user_pools {
  dayOfWeek: String!
  sessionMode: String!
  variant: String
  gameCount: Int!
  suggestedName: String!
  sampleGames: [PatternSampleGame!]!
}

type PreviewPatternsResult @aws_iam @aws_cognito_user_pools {
  venueId: ID!
  minOccurrences: Int!
  patternCount: Int!
  patterns: [CandidatePattern!]!
}

# ===================================================================
# RESULT TYPES - ADMIN OPERATIONS
# ===================================================================

type RecurringGameVenueStats @aws_iam @aws_cognito_user_pools {
  success: Boolean
  venueId: ID!
  totalRecurringGames: Int!
  totalGames: Int!
  orphanedRecurringGames: Int!
  orphans: [OrphanedRecurringGame!]!
  unassignedGames: Int!
  unassignedSample: [UnassignedGameSample!]!
  recurringGamesByDay: AWSJSON!
  gameDistribution: [RecurringGameDistribution!]!
}

type OrphanedRecurringGame @aws_iam @aws_cognito_user_pools {
  id: ID!
  name: String!
  dayOfWeek: String!
  createdAt: String
}

type UnassignedGameSample @aws_iam @aws_cognito_user_pools {
  id: ID!
  name: String!
  dayOfWeek: String
}

type RecurringGameDistribution @aws_iam @aws_cognito_user_pools {
  id: ID!
  name: String!
  dayOfWeek: String!
  gameCount: Int!
}

type DuplicateEntry @aws_iam @aws_cognito_user_pools {
  id: ID!
  name: String!
  similarity: Float!
  gameCount: Int!
}

type DuplicateGroup @aws_iam @aws_cognito_user_pools {
  canonicalId: ID!
  canonicalName: String!
  canonicalDayOfWeek: String!
  canonicalGameCount: Int!
  duplicates: [DuplicateEntry!]!
  totalGamesToReassign: Int!
}

type FindDuplicatesResult @aws_iam @aws_cognito_user_pools {
  success: Boolean
  venueId: ID!
  totalRecurringGames: Int!
  duplicateGroups: Int!
  duplicateEntries: Int!
  groups: [DuplicateGroup!]!
}

type MergeDetail @aws_iam @aws_cognito_user_pools {
  duplicateId: ID!
  gamesCount: Int!
}

type MergeDuplicatesResult @aws_iam @aws_cognito_user_pools {
  success: Boolean!
  error: String
  canonicalId: ID
  canonicalName: String
  duplicatesMerged: Int!
  gamesReassigned: Int!
  preview: Boolean!
  details: [MergeDetail!]
}

type CleanupOrphansResult @aws_iam @aws_cognito_user_pools {
  success: Boolean
  venueId: ID!
  orphansFound: Int!
  orphansRemoved: Int!
  preview: Boolean!
  orphans: [OrphanedRecurringGame!]!
}

type MatchDetails @aws_iam @aws_cognito_user_pools {
  matchedTo: String
  score: Int
  previousId: ID
  newId: ID
  dayOfWeek: String
}

type GameActionDetail @aws_iam @aws_cognito_user_pools {
  gameId: ID!
  gameName: String!
  action: String!
  matchDetails: MatchDetails
  error: String
}

type ActionSummary @aws_iam @aws_cognito_user_pools {
  REASSIGN: Int!
  CONFIRM: Int!
  SUGGEST_REASSIGN: Int!
  SUGGEST_CROSS_DAY: Int!
  SUGGEST_UNASSIGN: Int!
  NO_CHANGE: Int!
  SKIPPED: Int!
  ERROR: Int!
}

type ReResolveGameResult @aws_iam @aws_cognito_user_pools {
  success: Boolean!
  gameId: ID!
  gameName: String
  previousRecurringGameId: ID
  recurringGameId: ID
  recurringGameName: String
  matched: Boolean
  matchScore: Int
  preview: Boolean!
  error: String
}

type ReResolveVenueResult @aws_iam @aws_cognito_user_pools {
  success: Boolean
  venueId: ID!
  totalGames: Int!
  eligibleGames: Int!
  processed: Int!
  actions: ActionSummary!
  details: [GameActionDetail!]!
  preview: Boolean!
}

# ===================================================================
# QUERY RESULT TYPES (from original)
# ===================================================================

type RecurringGameWithStats @aws_iam @aws_cognito_user_pools {
  recurringGame: RecurringGame
  totalInstances: Int
  avgEntries: Float
  avgProfit: Float
  recentTrend: String 
  recentGames: [Game]
  consistency: String 
  profitability: String 
  attendanceHealth: String 
  topPlayers: [RecurringGamePlayerSummary]
}

type RecurringGamePlayerSummary @aws_iam @aws_cognito_user_pools {
  playerId: ID
  playerName: String
  appearances: Int
  avgFinish: Float
  totalWinnings: Float
}

type SearchRecurringGamesResult @aws_iam @aws_cognito_user_pools {
  items: [RecurringGame]
  total: Int
  nextToken: String
}

# ===================================================================
# MUTATIONS - gameDataEnricher
# ===================================================================

extend type Mutation {
  # Bulk Processing
  processUnassignedGames(input: ProcessUnassignedGamesInput!): ProcessUnassignedGamesResult!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
  
  reprocessDeferredGames(input: ReprocessDeferredInput!): ProcessUnassignedGamesResult!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
  
  # Admin Operations
  reResolveRecurringAssignment(input: ReResolveInput!): ReResolveGameResult!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
  
  reResolveRecurringAssignmentsForVenue(input: ReResolveVenueInput!): ReResolveVenueResult!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
  
  mergeRecurringGameDuplicates(input: MergeDuplicatesInput!): MergeDuplicatesResult!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
  
  cleanupOrphanedRecurringGames(input: CleanupOrphansInput!): CleanupOrphansResult!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
}

# ===================================================================
# QUERIES - gameDataEnricher
# ===================================================================

extend type Query {
  # Bulk Processing Stats
  getUnassignedGamesStats(input: UnassignedGamesStatsInput): UnassignedGamesStats!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
  
  previewCandidatePatterns(input: PreviewPatternsInput!): PreviewPatternsResult!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
  
  # Admin Operations
  getRecurringGameVenueStats(venueId: ID!): RecurringGameVenueStats!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
  
  findRecurringGameDuplicates(venueId: ID!, similarityThreshold: Float): FindDuplicatesResult!
    @function(name: "gameDataEnricher-${env}")
    @auth(rules: [{ allow: private }])
}
