# 86-social-processor.graphql
# ===================================================================
# SOCIAL POST PROCESSOR - Models, Types, and API
# ===================================================================
# This file contains:
# 1. New models for social post processing (junction table, extraction data, placements)
# 2. Embedded types for non-cash prizes
# 3. Input/output types for the processor API
# 4. Mutations and queries for the socialPostProcessor Lambda
# 5. Mutations and queries for the gameToSocialMatcher Lambda (reverse matching)
#
# DEPENDENCIES:
# - 00-enums.graphql: SocialPostContentType, SocialPostProcessingStatus, 
#                     SocialPostLinkType, NonCashPrizeType, GameStatus, etc.
# - 85-social.graphql: SocialPost model (extended)
# - 30-games.graphql: Game model (extended)
# ===================================================================

# ===================================================================
# 1. JUNCTION TABLE: SocialPostGameLink
# ===================================================================
# Many-to-many relationship between SocialPost and Game
# A single post can reference multiple games (rare but possible)
# A single game can be referenced by multiple posts (common - promo + result)

type SocialPostGameLink 
  @model(subscriptions: null) 
  @auth(rules: [{ allow: private }]) {
  
  id: ID!
  
  # === RELATIONSHIPS ===
  socialPostId: ID! 
    @index(name: "bySocialPostGameLink", sortKeyFields: ["matchConfidence"])
  gameId: ID! 
    @index(name: "byGameSocialPostLink", sortKeyFields: ["linkedAt"])
  
  # === LINK METADATA ===
  linkType: SocialPostLinkType! @default(value: "AUTO_MATCHED")
  matchConfidence: Float! @default(value: "0")
  matchReason: String                    # "tournament_id_exact", "venue_date_match", etc.
  matchSignals: AWSJSON                  # Detailed scoring breakdown { signalName: score }
  
  # === POSITION IN POST ===
  isPrimaryGame: Boolean @default(value: "false")
  mentionOrder: Int                      # Order of appearance (1, 2, 3...)
  
  # === EXTRACTED DATA SNAPSHOT ===
  # Denormalized for quick access without joining to SocialPostGameData
  extractedVenueName: String
  extractedDate: AWSDateTime
  extractedBuyIn: Float
  extractedGuarantee: Float
  
  # === AUDIT TRAIL ===
  linkedAt: AWSDateTime!
  linkedBy: String                       # "SYSTEM" or userId for manual links
  
  verifiedAt: AWSDateTime
  verifiedBy: String
  
  rejectedAt: AWSDateTime
  rejectedBy: String
  rejectionReason: String
  
  # === STANDARD FIELDS ===
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

# ===================================================================
# 2. EXTRACTION RESULTS: SocialPostGameData
# ===================================================================
# Stores all extracted game information from a social post
# One extraction per post (1:1 relationship with SocialPost)

type SocialPostGameData 
  @model(subscriptions: null) 
  @auth(rules: [{ allow: private }]) {
  
  id: ID!
  
  # === SOURCE ===
  socialPostId: ID! 
    @index(name: "bySocialPostExtraction", sortKeyFields: ["extractedAt"])
  
  # === POST CLASSIFICATION ===
  contentType: SocialPostContentType!    # RESULT, PROMOTIONAL, GENERAL, COMMENT
  contentTypeConfidence: Float
  resultScore: Int                       # Pattern match score for RESULT
  promoScore: Int                        # Pattern match score for PROMOTIONAL
  
  # === EXTRACTED TOURNAMENT IDENTITY ===
  extractedName: String
  extractedTournamentUrl: AWSURL
  # Tournament ID with GSI for reverse matching (game -> posts)
  extractedTournamentId: Int @index(name: "byTournamentId")
  
  # === EXTRACTED VENUE ===
  extractedVenueName: String
  extractedVenueId: ID                   # Matched venue ID (from dataExtractor)
  suggestedVenueId: ID                   # After venue matching (legacy, use extractedVenueId)
  venueMatchConfidence: Float
  venueMatchReason: String
  venueMatchSource: String               # "dataExtractor", "gameMatcher", etc.
  
  # === EXTRACTED DATE/TIME ===
  extractedDate: AWSDateTime             # Inferred game date
  extractedDayOfWeek: String             # MONDAY, TUESDAY, etc.
  extractedStartTime: String             # "6:00 PM", "7:30 PM"
  dateSource: String                     # "post_content", "posted_at", "url"
  
  # === EXTRACTED FINANCIALS ===
  extractedBuyIn: Float
  extractedGuarantee: Float
  extractedPrizePool: Float
  extractedFirstPlacePrize: Float
  extractedTotalPrizesPaid: Float
  extractedRake: Float                   # Extracted rake amount
  
  # === EXTRACTED ENTRIES (for RESULT posts) ===
  extractedTotalEntries: Int
  extractedTotalUniquePlayers: Int
  
  # === EXTRACTED GAME TYPE ===
  extractedGameType: GameType
  extractedTournamentType: TournamentType
  extractedGameVariant: GameVariant
  extractedGameTypes: [String]           # ["NLH", "Bounty", "Turbo"]
  
  # === EXTRACTED RECURRING GAME NAME ===
  extractedRecurringGameName: String     # For matching to recurring games
  
  # === SERIES EXTRACTION ===
  extractedSeriesName: String
  extractedEventNumber: Int
  extractedDayNumber: Int
  extractedFlightLetter: String
  isSeriesEvent: Boolean
  
  # === WINNER EXTRACTION (for RESULT posts) ===
  extractedWinnerName: String
  extractedWinnerPrize: Float
  placementCount: Int                    # Number of placements extracted
  
  # === MATCHING HINTS ===
  suggestedGameId: ID                    # Best match game ID
  matchCandidateCount: Int               # How many games were candidates
  
  # === RAW PATTERN DATA (for debugging) ===
  patternMatches: AWSJSON                # { resultMatches: [], promoMatches: [] }
  extractedPrizes: AWSJSON               # All $ amounts found with context
  
  # === PROCESSING METADATA ===
  extractedAt: AWSDateTime!
  extractionVersion: String              # "1.0.0" - for re-processing tracking
  extractionDurationMs: Int
  
  # === STANDARD FIELDS ===
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
  
  # === RELATIONSHIPS ===
  placements: [SocialPostPlacement] @hasMany(indexName: "byGameDataPlacement", fields: ["id"])
}

# ===================================================================
# 3. PLACEMENT RECORDS: SocialPostPlacement
# ===================================================================
# Individual prize records extracted from tournament results
# Handles both cash and non-cash prizes (accumulator tickets, etc.)

type SocialPostPlacement 
  @model(subscriptions: null) 
  @auth(rules: [{ allow: private }]) {
  
  id: ID!
  
  # === SOURCE ===
  socialPostGameDataId: ID! 
    @index(name: "byGameDataPlacement", sortKeyFields: ["place"])
  socialPostId: ID! 
    @index(name: "bySocialPostPlacement", sortKeyFields: ["place"])
  
  # === PLACEMENT DATA ===
  place: Int!                            # 1, 2, 3, etc.
  playerName: String!
  
  # === CASH PRIZE ===
  cashPrize: Float                       # Dollar amount (e.g., 570)
  cashPrizeRaw: String                   # Original text (e.g., "$570")
  
  # === NON-CASH PRIZES ===
  hasNonCashPrize: Boolean @default(value: "false")
  nonCashPrizes: AWSJSON                 # Array of SocialPostNonCashPrize objects
  
  # === TOTAL VALUE ===
  totalEstimatedValue: Float             # cashPrize + estimated value of non-cash
  
  # === DEAL INFORMATION ===
  wasChop: Boolean @default(value: "false")
  wasICMDeal: Boolean @default(value: "false")
  
  # === RAW DATA ===
  rawText: String                        # Original line from post
  
  # === LINKED PLAYER (future enhancement) ===
  linkedPlayerId: ID                     # If we can match to Player record
  
  # === STANDARD FIELDS ===
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

# ===================================================================
# 4. EMBEDDED TYPE: Non-Cash Prize
# ===================================================================
# Stored as AWSJSON in SocialPostPlacement.nonCashPrizes
# This is the structure of each item in that array

# Note: This is NOT a @model - it's an embedded type for documentation
# The actual data is stored as AWSJSON and parsed in the Lambda
type SocialPostNonCashPrize @aws_iam @aws_cognito_user_pools {
  prizeType: NonCashPrizeType!
  description: String                    # "Accumulator Ticket", "KR Event Entry"
  estimatedValue: Float                  # Estimated dollar value
  rawText: String                        # Original text (e.g., "Accumulator Ticket*")
  
  # For tournament entry prizes
  targetTournamentName: String
  targetTournamentBuyIn: Float
  
  # For ticket prizes
  ticketType: String                     # "ACCUMULATOR", "SATELLITE", "BOUNTY_HUNTER"
  ticketQuantity: Int
}

# ===================================================================
# 5. INPUT TYPES - SOCIAL POST PROCESSOR
# ===================================================================

input ProcessSocialPostInput {
  socialPostId: ID!
  forceReprocess: Boolean                # Re-process even if already done
  skipMatching: Boolean                  # Only extract, don't match
  skipLinking: Boolean                   # Extract and match, don't create links
  matchThreshold: Float                  # Override default match threshold (0-100)
}

input ProcessSocialPostBatchInput {
  # Option 1: Specific IDs
  socialPostIds: [ID!]
  
  # Option 2: Filter criteria
  socialAccountId: ID
  entityId: ID
  postedAfter: AWSDateTime
  postedBefore: AWSDateTime
  processingStatus: SocialPostProcessingStatus
  contentType: SocialPostContentType
  
  # Limits
  limit: Int                             # Max posts to process
  
  # Processing options
  forceReprocess: Boolean
  skipMatching: Boolean
  skipLinking: Boolean
}

input ManualLinkInput {
  socialPostId: ID!
  gameId: ID!
  isPrimaryGame: Boolean
  mentionOrder: Int
  notes: String
}

input UnlinkInput {
  linkId: ID!
  reason: String
}

input VerifyLinkInput {
  linkId: ID!
  notes: String
}

input RejectLinkInput {
  linkId: ID!
  reason: String!
}

input GetUnlinkedPostsInput {
  entityId: ID
  socialAccountId: ID
  contentType: SocialPostContentType
  minConfidence: Float                   # Filter by match confidence
  maxConfidence: Float
  limit: Int
  nextToken: String
}

input GetMatchingStatsInput {
  entityId: ID
  dateFrom: AWSDateTime
  dateTo: AWSDateTime
}

# NEW: Preview extraction on raw content without saving to database
input PreviewContentExtractionInput {
  content: String!                        # Post content to analyze
  postedAt: AWSDateTime                   # Optional: Posted date for matching
  platform: String                        # Optional: "FACEBOOK", etc.
  entityId: ID                            # Optional: For venue/game filtering
  venueId: ID                             # Optional: For game filtering
  url: String                             # Optional: Post URL for extraction hints
}

# ===================================================================
# 5b. INPUT TYPES - GAME TO SOCIAL MATCHER (Reverse Matching)
# ===================================================================

input MatchGameToSocialPostsInput {
  gameId: ID!
  autoLinkThreshold: Int                 # Override default (80)
  maxCandidates: Int                     # Max posts to evaluate (default 100)
  previewOnly: Boolean                   # If true, don't create links
}

input BatchMatchGamesToSocialPostsInput {
  gameIds: [ID!]!
  autoLinkThreshold: Int
  maxCandidates: Int
  previewOnly: Boolean
}

input PreviewGameToSocialMatchInput {
  gameId: ID!
  autoLinkThreshold: Int                 # Show candidates above this threshold (default 0 = all)
  maxCandidates: Int                     # Max posts to evaluate
}

# ===================================================================
# 6. OUTPUT TYPES - SOCIAL POST PROCESSOR
# ===================================================================

type ProcessSocialPostResult @aws_iam @aws_cognito_user_pools {
  success: Boolean!
  socialPostId: ID                        # Nullable for preview mode (no saved post)
  
  # Processing status
  processingStatus: SocialPostProcessingStatus
  error: String
  warnings: [String!]
  
  # Extraction results
  extractedGameData: SocialPostGameData
  placementsExtracted: Int
  
  # Matching results
  matchCandidates: [GameMatchCandidate!]
  primaryMatch: GameMatchCandidate
  
  # Linking results
  linksCreated: Int
  linksSkipped: Int                      # Below threshold
  linkDetails: [SocialPostGameLink!]
  
  # Metadata
  processingTimeMs: Int
}

type GameMatchCandidate @aws_iam @aws_cognito_user_pools {
  gameId: ID!
  gameName: String
  gameDate: AWSDateTime
  gameStatus: GameStatus
  venueId: ID
  venueName: String
  entityId: ID
  
  buyIn: Float
  guaranteeAmount: Float
  totalEntries: Int
  
  # Scoring
  matchConfidence: Float!
  matchReason: String
  matchSignals: AWSJSON                  # Detailed breakdown
  
  # Selection
  rank: Int
  isPrimaryMatch: Boolean
  wouldAutoLink: Boolean                 # Above threshold
  rejectionReason: String                # If below threshold
}

type ProcessBatchResult @aws_iam @aws_cognito_user_pools {
  success: Boolean!
  totalProcessed: Int!
  successCount: Int!
  failedCount: Int!
  skippedCount: Int!
  
  # Results by ID
  results: [ProcessSocialPostResult!]
  
  # Aggregate stats
  totalLinksCreated: Int
  totalExtractionsDone: Int
  averageConfidence: Float
  
  # Timing
  processingTimeMs: Int
}

type SocialPostMatchingStats @aws_iam @aws_cognito_user_pools {
  totalPosts: Int!
  processedPosts: Int!
  linkedPosts: Int!
  pendingPosts: Int!
  failedPosts: Int!
  
  # By content type
  resultPosts: Int!
  promotionalPosts: Int!
  generalPosts: Int!
  
  # Link quality
  autoLinkedCount: Int!
  manualLinkedCount: Int!
  verifiedCount: Int!
  rejectedCount: Int!
  averageConfidence: Float
  
  # Top matching reasons
  topMatchReasons: AWSJSON               # { reason: count }
}

type UnlinkedPostsConnection @aws_iam @aws_cognito_user_pools {
  items: [SocialPostWithMatchInfo!]!
  nextToken: String
  totalCount: Int
}

type SocialPostWithMatchInfo @aws_iam @aws_cognito_user_pools {
  socialPost: SocialPost!
  extractedData: SocialPostGameData
  suggestedMatches: [GameMatchCandidate!]
  bestMatchConfidence: Float
}

# ===================================================================
# 6b. OUTPUT TYPES - GAME TO SOCIAL MATCHER
# ===================================================================

type GameToSocialMatchResult @aws_iam @aws_cognito_user_pools {
  success: Boolean!
  gameId: ID
  gameName: String
  gameDate: AWSDateTime
  
  # Search results
  candidatesFound: Int                   # Total posts in search range
  candidatesScored: Int                  # Posts that met minimum threshold
  
  # Linking results
  linksCreated: Int
  linksSkipped: Int                      # Already linked or duplicate
  existingLinks: Int                     # Links that existed before
  
  # Matched posts details
  matchedPosts: [SocialPostMatchCandidate!]
  linkDetails: [GameToSocialLinkDetail!]
  
  # Match context
  matchContext: GameToSocialMatchContext
  
  # Metadata
  processingTimeMs: Int
  error: String
}

type SocialPostMatchCandidate @aws_iam @aws_cognito_user_pools {
  socialPostId: ID!
  postDate: AWSDateTime
  contentType: SocialPostContentType
  extractedBuyIn: Float
  extractedVenueName: String
  
  # Scoring
  matchConfidence: Int!
  matchReason: String
  matchSignals: AWSJSON
  
  # Selection
  rank: Int
  isPrimaryGame: Boolean
  mentionOrder: Int
  wouldLink: Boolean                     # Above threshold (for preview)
}

type GameToSocialLinkDetail @aws_iam @aws_cognito_user_pools {
  socialPostId: ID!
  linkId: ID
  status: String!                        # "CREATED", "SKIPPED", "ERROR"
  reason: String                         # e.g., "already_linked"
  matchConfidence: Int
  error: String
}

type GameToSocialMatchContext @aws_iam @aws_cognito_user_pools {
  matchMethod: String                    # "tournament_id", "venue_date", "date_only"
  venueId: ID
  venueName: String
  searchRange: DateRange
  candidatesScored: Int
  candidatesAboveMinimum: Int
}

type DateRange @aws_iam @aws_cognito_user_pools {
  searchStart: AWSDateTime
  searchEnd: AWSDateTime
}

type BatchGameToSocialMatchResult @aws_iam @aws_cognito_user_pools {
  totalRequested: Int!
  processed: Int!
  totalLinksCreated: Int!
  totalLinksSkipped: Int!
  results: [GameToSocialMatchResult!]
}

# ===================================================================
# 7. MUTATIONS - SOCIAL POST PROCESSOR
# ===================================================================

extend type Mutation {
  # Process single post (sync)
  processSocialPost(input: ProcessSocialPostInput!): ProcessSocialPostResult
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # Process batch (async for large batches)
  processSocialPostBatch(input: ProcessSocialPostBatchInput!): ProcessBatchResult
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # Manual link operations
  linkSocialPostToGame(input: ManualLinkInput!): SocialPostGameLink
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  unlinkSocialPostFromGame(input: UnlinkInput!): Boolean
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # Admin verification
  verifySocialPostLink(input: VerifyLinkInput!): SocialPostGameLink
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  rejectSocialPostLink(input: RejectLinkInput!): SocialPostGameLink
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # =========================================================
  # GAME TO SOCIAL MATCHER (Reverse Matching)
  # =========================================================
  
  # Match a single game to social posts
  matchGameToSocialPosts(input: MatchGameToSocialPostsInput!): GameToSocialMatchResult
    @function(name: "gameToSocialMatcher-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # Match multiple games to social posts
  batchMatchGamesToSocialPosts(input: BatchMatchGamesToSocialPostsInput!): BatchGameToSocialMatchResult
    @function(name: "gameToSocialMatcher-${env}")
    @aws_iam
    @aws_cognito_user_pools
}

# ===================================================================
# 8. QUERIES
# ===================================================================

extend type Query {
  # Preview matching without saving (requires saved post)
  previewSocialPostMatch(socialPostId: ID!): ProcessSocialPostResult
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # NEW: Preview extraction on raw content WITHOUT saving
  # Use this to see what would be extracted before uploading a post
  previewContentExtraction(input: PreviewContentExtractionInput!): ProcessSocialPostResult
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # Get posts needing review
  getUnlinkedSocialPosts(input: GetUnlinkedPostsInput): UnlinkedPostsConnection
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # Get matching stats
  getSocialPostMatchingStats(input: GetMatchingStatsInput): SocialPostMatchingStats
    @function(name: "socialPostProcessor-${env}")
    @aws_iam
    @aws_cognito_user_pools
  
  # =========================================================
  # GAME TO SOCIAL MATCHER (Reverse Matching)
  # =========================================================
  
  # Preview which posts would match a game (no links created)
  previewGameToSocialMatch(input: PreviewGameToSocialMatchInput!): GameToSocialMatchResult
    @function(name: "gameToSocialMatcher-${env}")
    @aws_iam
    @aws_cognito_user_pools
}